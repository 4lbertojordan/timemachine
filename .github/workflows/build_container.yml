name: Build Container

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "**.md"
      - ".gitignore"
      - "LICENSE"
  workflow_dispatch:

jobs:
  build-secure-push:
    name: Build, Scan & Push
    runs-on: [ubuntu-latest]
    permissions:
      contents: write
      packages: write

    steps:
      - name: Pre-cleanup workspace
        run: sudo rm -rf * || true

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Define Version Variables
        id: vars
        run: |
          IMAGE_TAG="1.0.${{ github.run_number }}"
          echo "VERSION=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "::notice::Container image will be: jord4ncodes/timemachine:${IMAGE_TAG}"

      - name: Detect Secrets
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Local for Security Check
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./smb.dockerfile
          load: true
          push: false
          tags: jord4ncodes/timemachine:${{ steps.vars.outputs.VERSION }}

      - name: Run Trivy Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "jord4ncodes/timemachine:${{ steps.vars.outputs.VERSION }}"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL"
          output: "trivy-results.txt"

      - name: Publish Trivy Report
        run: |
          echo "## ðŸ›¡ï¸ Trivy Security Report" >> $GITHUB_STEP_SUMMARY
          echo "### Image: jord4ncodes/timemachine:${{ steps.vars.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat trivy-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Build and Push Multi-arch
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./smb.dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            jord4ncodes/timemachine:${{ steps.vars.outputs.VERSION }}
            jord4ncodes/timemachine:latest

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.vars.outputs.VERSION }}
          release_name: Release v${{ steps.vars.outputs.VERSION }}
          body: |
            âœ… Security Scan Passed
            Build: #${{ github.run_number }}.
            Image: jord4ncodes/timemachine:${{ steps.vars.outputs.VERSION }}
          draft: false
          prerelease: false

      - name: ðŸ§¹ Docker Cleanup (Local)
        if: always()
        run: |
          echo "Deleting local images..."
          docker rmi jord4ncodes/timemachine:${{ steps.vars.outputs.VERSION }} || true
          docker rmi jord4ncodes/timemachine:latest || true
          docker builder prune -f
          docker image prune -f
          echo "Container images cleaned up."

      - name: ðŸ§¹ Rotate GitHub Releases (Keep last 3)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const keepCount = 3;
            const { data: releases } = await github.rest.repos.listReleases({ owner, repo, per_page: 100 });
            const sorted = releases.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            if (sorted.length > keepCount) {
              const toDelete = sorted.slice(keepCount);
              for (const r of toDelete) {
                console.log(`Deleting release: ${r.name}`);
                await github.rest.repos.deleteRelease({ owner, repo, release_id: r.id });
                try { await github.rest.git.deleteRef({ owner, repo, ref: `tags/${r.tag_name}` }); } catch (e) {}
              }
            }

      - name: ðŸ§¹ Workspace Cleanup
        if: always()
        run: sudo rm -rf *
